<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Local RAG â€“ Document Upload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        padding: 2rem;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .card {
        background: #020617;
        border: 1px solid #1e293b;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        max-width: 600px;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      input[type='file'],
      input[type='text'] {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
        background: #020617;
        border: 1px solid #334155;
        border-radius: 4px;
        color: #e5e7eb;
      }

      button {
        padding: 0.6rem 1.2rem;
        background: #2563eb;
        border: none;
        border-radius: 4px;
        color: white;
        font-weight: 600;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      th,
      td {
        padding: 0.5rem;
        border-bottom: 1px solid #1e293b;
        text-align: left;
        font-size: 0.85rem;
      }

      th {
        color: #93c5fd;
        font-weight: 600;
      }

      .ok {
        color: #22c55e;
      }

      .err {
        color: #ef4444;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“„ Local RAG â€“ Document Upload</h1>

    <!-- Upload Card -->
    <div class="card">
      <form id="uploadForm">
        <label for="title">Title (optional)</label>
        <input
          type="text"
          id="title"
          name="title"
          placeholder="Document title"
        />

        <label for="file">Select document</label>
        <input type="file" id="file" name="file" required />

        <button type="submit">Upload</button>
      </form>

      <div id="uploadStatus" class="status"></div>
    </div>

    <!-- Document List -->
    <div class="card">
      <h2>Uploaded Documents</h2>
      <button onclick="loadDocuments()">Refresh</button>

      <table id="docsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Filename</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const API_BASE = 'http://localhost:8000';

      const uploadForm = document.getElementById('uploadForm');
      const statusDiv = document.getElementById('uploadStatus');
      const docsTableBody = document.querySelector('#docsTable tbody');

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusDiv.textContent = '';
        statusDiv.className = 'status';

        const fileInput = document.getElementById('file');
        if (!fileInput.files.length) {
          statusDiv.textContent = 'Please select a file.';
          statusDiv.classList.add('err');
          return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const title = document.getElementById('title').value;
        if (title) formData.append('title', title);

        try {
          const res = await fetch(`${API_BASE}/documents`, {
            method: 'POST',
            body: formData,
          });

          if (!res.ok) {
            const txt = await res.text();
            throw new Error(txt || 'Upload failed');
          }

          const data = await res.json();
          statusDiv.innerHTML = `
        <span class="ok">
          Uploaded âœ”<br/>
          doc_id=${data.doc_id}, version_id=${data.version_id}, status=${data.status}
        </span>
      `;
          uploadForm.reset();
          loadDocuments();
        } catch (err) {
          statusDiv.textContent = `Error: ${err.message}`;
          statusDiv.classList.add('err');
        }
      });

      async function loadDocuments() {
        docsTableBody.innerHTML = '';
        try {
          const res = await fetch(`${API_BASE}/documents`, {
            credentials: 'include',
          });
          if (!res.ok) throw new Error('Failed to fetch documents');
          const docs = await res.json();

          for (const d of docs) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${d.doc_id}</td>
          <td>${d.title || ''}</td>
          <td>${d.filename || ''}</td>
          <td>${d.status}</td>
        `;
            docsTableBody.appendChild(tr);
          }
        } catch (err) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="4" class="err">Failed to load documents</td>`;
          docsTableBody.appendChild(tr);
        }
      }

      // initial load
      loadDocuments();
    </script>
  </body>
</html>
